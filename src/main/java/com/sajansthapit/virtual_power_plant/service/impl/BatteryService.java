package com.sajansthapit.virtual_power_plant.service.impl;import com.sajansthapit.virtual_power_plant.dto.BatteryDto;import com.sajansthapit.virtual_power_plant.dto.request.BatteryFilterRequest;import com.sajansthapit.virtual_power_plant.dto.request.BatteryRequest;import com.sajansthapit.virtual_power_plant.dto.response.BatteryFilterResponse;import com.sajansthapit.virtual_power_plant.dto.response.BatterySaveResponse;import com.sajansthapit.virtual_power_plant.exception_handler.exceptions.DuplicateBatteryException;import com.sajansthapit.virtual_power_plant.exception_handler.exceptions.InvalidPostCodeRangeException;import com.sajansthapit.virtual_power_plant.model.Battery;import com.sajansthapit.virtual_power_plant.repository.BatteryRepository;import com.sajansthapit.virtual_power_plant.service.IBatteryService;import lombok.AllArgsConstructor;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import java.util.*;@Service@AllArgsConstructorpublic class BatteryService implements IBatteryService {    private final BatteryRepository batteryRepository;    @Override    @Transactional    public BatterySaveResponse saveAll(BatteryRequest batteryRequest) {        List<String> errorMessage = new ArrayList<>();        Set<Battery> batteriesList = new HashSet<>();        for (BatteryDto battery : batteryRequest.batteries()) {            try {                checkDuplicate(battery);                batteriesList.add(Battery.builder()                        .name(battery.name())                        .postCode(battery.postCode())                        .wattCapacity(battery.wattCapacity())                        .build());            } catch (DuplicateBatteryException exception) {                errorMessage.add(exception.getMessage());            }        }        if (!batteriesList.isEmpty()) {            batteryRepository.saveAll(batteriesList);        }        String message = "Total of " + batteriesList.size() + " batteries saved successfully.";        if (!errorMessage.isEmpty()) {            message += " Some errors were found: " + errorMessage;        }        return new BatterySaveResponse(message);    }    @Override    public BatteryFilterResponse filter(BatteryFilterRequest batteryFilterRequest) {        if (Integer.parseInt(batteryFilterRequest.postCodeTo()) < Integer.parseInt(batteryFilterRequest.postCodeFrom())) {            throw new InvalidPostCodeRangeException("Invalid post code range provided");        }        List<Battery> filteredBatteries = batteryRepository.findByPostCodeRange                (Integer.parseInt(batteryFilterRequest.postCodeFrom()),                        Integer.parseInt(batteryFilterRequest.postCodeTo()));        List<BatteryDto> batteryDtoList = filteredBatteries.stream()                .sorted(Comparator.comparing(Battery::getName))                .map(battery ->                        new BatteryDto(battery.getName(), battery.getPostCode(), battery.getWattCapacity())                ).toList();        int totalWattCapacity = calculateTotalWattCapacity(batteryDtoList);        double averageWattCapacity = calculateAverageWattCapacity(batteryDtoList);        return new BatteryFilterResponse("Batteries list fetched successfully", batteryDtoList, batteryDtoList.size(), totalWattCapacity, averageWattCapacity);    }    private void checkDuplicate(BatteryDto battery) throws DuplicateBatteryException {        batteryRepository.findByNameAndPostCodeAndWattCapacity(battery.name(), battery.postCode(), battery.wattCapacity())                .ifPresent(existingBattery -> {                    throw new DuplicateBatteryException("Battery with name " + battery.name() + " and " + battery.postCode() + " of postcode and " + battery.wattCapacity() + " watt capacity already exists in database");                });    }    private int calculateTotalWattCapacity(List<BatteryDto> batteryDtoList) {        return batteryDtoList.stream().mapToInt(BatteryDto::wattCapacity).sum();    }    private double calculateAverageWattCapacity(List<BatteryDto> batteryDtoList) {        return batteryDtoList.stream().mapToDouble(BatteryDto::wattCapacity)                .average().orElse(0);    }}